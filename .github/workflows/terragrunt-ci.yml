name: Terragrunt CI

on:
  pull_request:
    paths:
      - "**/*.tf"
      - "**/*.hcl"
      - ".github/workflows/**"
      - "modules/**"
      - "nz3es/**"

jobs:
  validate:
    name: Terragrunt validate
    runs-on: ubuntu-latest
    env:
      # Prevent Terraform from printing the 'Your version of Terraform is out of date' message
      # which can break parsers that read `terraform --version` (Terragrunt in CI).
      TF_CLI_DISABLE_UPDATE_CHECK: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "1.6.0"

      - name: Terraform format check
        # Fast, local formatting check to enforce canonical formatting on all .tf files
        run: |
          terraform fmt -check -recursive

      - name: Install Terragrunt
        run: |
          TG_VER=v0.55.20
          curl -L "https://github.com/gruntwork-io/terragrunt/releases/download/${TG_VER}/terragrunt_linux_amd64" -o terragrunt
          chmod +x terragrunt
          sudo mv terragrunt /usr/local/bin/terragrunt

      - name: Terragrunt validate (safer)
        run: |
          # Initialize Terraform in all stacks without touching remote backends (fast, safe for PRs)
          terragrunt run --all -- terraform init -backend=false
          # Validate Terraform configurations across all stacks
          terragrunt run --all -- terraform validate
